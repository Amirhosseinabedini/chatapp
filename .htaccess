# Symfony routing configuration for Ionos and shared hosting
# This handles routing when document root is the project root

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    
    # If index.php is in URL, remove it and redirect to clean URL
    # This handles cases where users access /index.php/login and redirects to /login
    # Must be checked before other rules to catch direct index.php requests
    # Use THE_REQUEST to catch the original request before Apache processes it
    # Handle /index.php/path -> /path
    RewriteCond %{THE_REQUEST} \s/+index\.php/([^\s?]+) [NC]
    RewriteRule ^index\.php/(.+)$ /%1 [R=301,L]
    # Handle /index.php -> /
    RewriteCond %{THE_REQUEST} \s/+index\.php[\s?] [NC]
    RewriteRule ^index\.php$ / [R=301,L]
    
    # If requesting an actual file or directory in root, serve it
    # But skip index.php to allow redirect rules above to work
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteCond %{REQUEST_URI} !^/index\.php [NC]
    RewriteRule ^ - [L]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
    
    # If file exists in public/, serve it from there
    RewriteCond %{DOCUMENT_ROOT}/public%{REQUEST_URI} -f [OR]
    RewriteCond %{DOCUMENT_ROOT}/public%{REQUEST_URI} -d
    RewriteRule ^(.*)$ public/$1 [L]
    
    # Otherwise, route through root index.php (which bootstraps Symfony)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>

# Security: Prevent direct access to sensitive files and directories
<FilesMatch "^(\.env|composer\.(json|lock)|symfony\.lock|\.git)">
    Require all denied
</FilesMatch>

<FilesMatch "^(\.env\.local|\.env\.prod|\.env\.dev)">
    Require all denied
</FilesMatch>

# Prevent directory listing
Options -Indexes

